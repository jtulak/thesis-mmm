\chapter{Refactoring of mkfs.xfs} \label{chap:refactoring}
As is shown in~\ref{chap:xfs:mkfs}, the situation was not ideal and the state of the code led to many known issues. David Chinner, then maintainer of XFS, presented a set of patches as a request for comment (RFC) in November 2013~\cite{davidsPatches} in an attempt to raise a discussion, however, nobody joined it and David Chinner himself didn't continue in pressing this matter for few years.

When I joined the XFS team and began with the refactoring in 2015~\cite{myFirstPatches}, I picked up this patchset and brought it up to date with the codebase that in some parts changed substantially in the two years. Then I continued when David Chinner left off, fixing issues with his patches and adding further changes. This first part took until May 2016, when it was merged into the upstream repository~\cite{finalPatchset1,finalPatchset1Announce}.

Once this change was merged and provided a stable point so I didn't have to keep so much code in my own local repository up to date with upstream, I began to work on the second set of changes. I submitted an RFC of these changes in December 2016~\cite{secondSetRFC} and as of now, I'm awaiting a review. Such a big and complex changes are usually reviewed only by the maintainer who changed in late December -- Eric Sandeen took this position instead of David Chinner. This probably caused some delay.

The idea of changes described in this work is to create a table which holds values like minimum/maximum, default values, conflicts and others. And instead of ad-hoc conditions and operations, there will be just one global structure, well documented and easily readable and extendable. This structure should hold also the user-entered values and limit code and variables duplication as much as possible.

\section{First patchset}\label{chap:refactoring:first}
The first patchset implemented the core parts from the desired state. The implementation of the basic table made the {\tt mkfs\_xfs.c} file more readable, even if it was possible to remove only basic checks. It also brought a much more strict input validation, so few of the existing tests in xfstests had to be updated and a new test was created, with the goal to watch only for input validation, whether {\tt mkfs.xfs} correctly accepts or refuses any given combination of options and values.

Size of this patchset is 19 patches and the total changes are:
\begin{lstlisting}[frame=none, basicstyle=\footnotesize\ttfamily, language=Bash, numbers=none, numberstyle=\tiny\color{black},caption= {Git statistics for the first patchset~\cite{finalPatchset1}.}]
include/Makefile        |    5 +-
 include/xfs_multidisk.h |   73 ++
 libxfs/init.c           |    6 +
 libxfs/linux.c          |   11 +-
 man/man8/mkfs.xfs.8     |   45 +-
 mkfs/Makefile           |    2 +-
 mkfs/maxtrres.c         |    2 +-
 mkfs/proto.c            |   58 +-
 mkfs/xfs_mkfs.c         | 1983 +++++++++++++++++++++++++++++------------------
 mkfs/xfs_mkfs.h         |   89 ---
 repair/xfs_repair.c     |   44 +-
11 files changed, 1417 insertions(+), 901 deletions(-)
\end{lstlisting}


\section{Second patchset}\label{chap:refactoring:second}
The second part of my changes is focused mostly on conflicts detection and allows for almost all checks to be removed from the code as ad-hoc solutions, as the new structures and functions take care of them automatically. Any programmer making a change just has to correctly specify values in a {\tt struct opt\_params}, write in a list of conflicting options, and the validation of the new option is guaranteed to work correctly and seamlessly.

Size of this patchset in the first RFC is 22 patches and the total changes are:
\begin{lstlisting}[frame=none, basicstyle=\footnotesize\ttfamily, language=Bash, numbers=none, numberstyle=\tiny\color{black},caption= {Git statistics for the second patchset~\cite{secondSetRFC}.}]
 mkfs/xfs_mkfs.c | 2952 +++++++++++++++++++++++++++++++++++--------------------
 1 file changed, 1864 insertions(+), 1088 deletions(-)
\end{lstlisting}


